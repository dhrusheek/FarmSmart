generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  farmer
  buyer
  admin
}

enum TransactionType {
  income
  expense
}

enum AuctionStatus {
  active
  completed
  cancelled
}

enum DisputeStatus {
  open
  in_review
  resolved
  rejected
}

enum FraudAlertType {
  abnormal_bid
  rapid_bidding
}

enum AdvisoryCategory {
  Disease
  Pest
  Soil
  Irrigation
  Weather
  Market
}

enum AdvisorySeverity {
  Low
  Medium
  High
}

enum MarketFreshness {
  live
  recent
  stale
}

model User {
  id                String        @id @default(cuid())
  name              String
  phone             String?       @unique
  email             String        @unique
  passwordHash      String
  role              Role          @default(farmer)
  location          String?
  farmSize          String?
  preferredLanguage String?       
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  crops             Crop[]
  inventoryItems    InventoryItem[]
  transactions      Transaction[]
  auctions          Auction[]      @relation("AuctionSeller")
  bids              Bid[]
  disputesRaised    Dispute[]      @relation("DisputeRaisedBy")
  disputesAgainst   Dispute[]      @relation("DisputeAgainstUser")
  fraudAlerts       FraudAlert[]
}

model Crop {
  id           String   @id @default(cuid())
  userId       String
  name         String
  type         String
  plantingDate DateTime
  status       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
}

model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  name      String
  category  String
  quantity  Float
  unit      String
  location  String
  minStock  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  date        DateTime
  description String
  type        TransactionType
  amount      Float
  category    String
  cropId      String?
  createdAt   DateTime        @default(now())

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  crop        Crop?           @relation(fields: [cropId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([cropId])
  @@index([date])
}

model MarketPrice {
  id          String         @id @default(cuid())
  crop        String
  currentPrice Float
  unit        String
  change      Float
  trend       Json
  region      String
  verified    Boolean        @default(false)
  source      String
  lastUpdated DateTime       @default(now())
  freshness   MarketFreshness @default(recent)

  @@index([crop])
  @@index([region])
  @@index([freshness])
}

model Auction {
  id               String       @id @default(cuid())
  sellerId         String
  crop             String
  quantity         Float
  unit             String
  startingPrice    Float
  currentBid       Float         @default(0)
  minimumIncrement Float         @default(1)
  endsAt           DateTime
  status           AuctionStatus @default(active)
  createdAt        DateTime      @default(now())

  seller           User          @relation("AuctionSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  bids             Bid[]
  fraudAlerts      FraudAlert[]
  disputes         Dispute[]

  @@index([sellerId])
  @@index([status])
  @@index([endsAt])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  userId    String
  amount    Float
  timestamp DateTime @default(now())

  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([userId])
  @@index([timestamp])
}

model FraudAlert {
  id        String         @id @default(cuid())
  auctionId String
  userId    String
  type      FraudAlertType
  message   String
  timestamp DateTime       @default(now())

  auction   Auction        @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([userId])
  @@index([type])
}

model Dispute {
  id             String        @id @default(cuid())
  auctionId      String?
  raisedById     String
  againstUserId  String?
  title          String
  description    String
  status         DisputeStatus @default(open)
  resolutionNotes String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  auction        Auction?      @relation(fields: [auctionId], references: [id], onDelete: SetNull)
  raisedBy       User          @relation("DisputeRaisedBy", fields: [raisedById], references: [id], onDelete: Cascade)
  againstUser    User?         @relation("DisputeAgainstUser", fields: [againstUserId], references: [id], onDelete: SetNull)

  @@index([auctionId])
  @@index([raisedById])
  @@index([status])
}

model Advisory {
  id         String            @id @default(cuid())
  title      String
  category   AdvisoryCategory
  targetCrop String
  severity   AdvisorySeverity
  symptoms   String
  management String
  prevention String

  @@index([targetCrop])
  @@index([category])
  @@index([severity])
}

model AiModel {
  id          String   @id @default(cuid())
  name        String
  version     String
  accuracy    Float
  lastTrained DateTime
  status      String
  drift       Float
  predictions Json

  @@index([name])
}

model AiJob {
  id        String   @id @default(cuid())
  modelId   String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  model     AiModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId])
  @@index([status])
}
